---
title: 'Authorization Flow'
description: 'Allow your users to connect their SID account to your application'
---
<Note>
This page assumes that you have already registered your application with SID, received your client credentials,
and set them as environment varibles. See the [credentials](/auth/credentials) page for more details.
</Note>

## Initiate Flow
The authorization flow is initiated by redirecting a user to the SID authorization URL, shown below:
```bash
https://me.sid.ai/api/oauth/authorize
```
To initiate the flow, you must set up the following query parameters in the URL:
<CodeGroup>
```typescript Node.js
import { URLSearchParams } from 'url';

const params = {
    'response_type': 'code',
    'scope': 'query:data offline_access',
    'client_id': process.env.SID_CLIENT_ID,
    'redirect_uri': process.env.SID_REDIRECT_URI,
};

const authUrl = new URL('https://me.sid.ai/api/oauth/authorize');
authUrl.search = new URLSearchParams(params).toString();

// redirect user to authUrl created above
```

```python Python
params = {
    'response_type': 'code',
    'scope': 'query:data offline_access',
    'client_id': env.SID_CLIENT_ID,
    'redirect_uri': env.SID_REDIRECT_URI,
}
auth_url = 'https://me.sid.ai/api/oauth/authorize'
auth_url += '?' + urlencode(params)

# redirect user to auth_url created above
``` 

</CodeGroup>

<Note>
The required scopes are currently fixed to `query:data` and `offline_access`. 
The former allows usage of the query endpoint, and the latter allows refreshing of tokens.
In the future, the API may support more granular scopes.
</Note>
This is an example of a valid authorization URL created for `example.com`:
```bash
https://me.sid.ai/api/oauth/authorize?response_type=code&scope=query%3Adata+offline_access&client_id=my_client_id&redirect_uri=https%3A%2F%2Fexample.com%2Fcallback
```

You then need to redirect the user to this URL. 
Usually, this will happen through a button or link in your application, 
which could be located in a settings page, or on the user's profile page.


## Callback
The authorization URL will redirect the user to their SID account, 
where they will be prompted to log in and grant access permissions to your application.
Once they have done so, they will be redirected back to your application with an authorization code. 
You will need to provide a redirect URI to receive this code.

For example, if your application is hosted at `https://example.com`, you could specify a redirect URI of `https://example.com/api/sid/callback`. 
You should then handle incoming `GET` requests to this URI to receive the authorization code, which is provided in the `code` query parameter.

Continuing with the example, a possible callback would be a `GET` request to `https://example.com/api/sid/callback?code=96843854772`.

After handling the callback, you should redirect the user back to your application. 
In the following example, the user is redirected to `https://example.com`, 
but you can redirect them to any page in your application.

<Note>
The token exchange is discussed in the next section.
</Note>

<CodeGroup>

```typescript Node.js (Next)
import { NextApiRequest, NextApiResponse } from 'next';

export default async function handler(req: NextApiRequest, res: NextApiResponse) {
  // get authorization code from query string
  let code = req.query.code;
  // perform token exchange to get access token and refresh token
  let { accessToken, refreshToken } = await tokenExchange(code);

  // save tokens to database 
  // ...

  // redirect user back to your application
  res.redirect('http://example.com');
}
```

```typescript Node.js (Next App Router)
export async function GET(request: Request) {
  // get authorization code from query string
  let code = request.query.get('code');
  // perform token exchange to get access token and refresh token
  let { accessToken, refreshToken } = await tokenExchange(code);

  // save tokens to database
  // ...

  // redirect user back to your application
  return Response.redirect('http://example.com');
}
```

```python Python (FastAPI)
app = FastAPI()

@app.get("/sid/callback")
async def read_root(request: Request):
    code = request.query_params.get('code')
    # perform token exchange to get access token and refresh token
    accessToken, refreshToken = await token_exchange(code)
    
    # save tokens to database 
    # ...

    # redirect user back to your application
    return RedirectResponse('http://example.com')
```
</CodeGroup>

After the user has been redirected back to your application, the authorization flow is complete.
You now have an access token and a refresh token, which you can use to make requests to the SID API.

<Warning>
Do _not_ persist the authorization code. It is only valid for a few minutes, and its sole purpose is to be exchanged for tokens.
</Warning>


## Token Exchange
The authorization code received in the callback is only valid for a short time, and must be converted
into an access token and a refresh token using a token exchange, as shown below:

<CodeGroup>
```typescript Node.js
import axios from 'axios';

async function tokenExchange(code: string) {
// construct data to send to SID
  const data = {
    grant_type: 'authorization_code',
    client_id: process.env.SID_CLIENT_ID,
    client_secret: process.env.SID_CLIENT_SECRET,
    redirect_uri: process.env.SID_REDIRECT_URI,
    code: code,
  };

  // send request to SID token endpoint
  const response = await axios.post('https://auth.sid.ai/oauth/token', data);

  // return tokens
  return {
    refreshToken: response.data.refresh_token,
    accessToken: response.data.access_token,
    expiresIn: response.data.expires_in,
  }
}
```
```python Python
import os
import httpx

async def token_exchange(code: str):
    # construct data to send to SID
    data = {
        'grant_type': 'authorization_code',
        'client_id': os.environ.get('SID_CLIENT_ID'),
        'client_secret': os.environ.get('SID_CLIENT_SECRET'),
        'redirect_uri': os.environ.get('SID_REDIRECT_URI'),
        'code': code,
    }

    # send request to SID token endpoint
    async with httpx.AsyncClient() as client:
        response = await client.post('https://auth.sid.ai/oauth/token', data=data)

    data = response.json()

    return {
        'refresh_token': data['refresh_token'],
        'access_token': data['access_token'],
        'expires_in': data['expires_in'],
    }
```
</CodeGroup>

## Refreshing Tokens
The access token is valid for a limited time period. After it expires, 
you will need to use the accompanying refresh token to obtain a new access token.
The below code example shows the process.

<CodeGroup>
```typescript Node.js
let refreshToken = /* database query */;

const data = {
    grant_type: 'refresh_token',
    client_id: process.env.SID_CLIENT_ID,
    client_secret: process.env.SID_CLIENT_SECRET,
    redirect_uri: process.env.SID_REDIRECT_URL,
    refresh_token: refreshToken,
};
const response = await axios.post('https://auth.sid.ai/oauth/token', data);
const { access_token } = response.data;
```

```python Python
import os
import httpx

refresh_token = # database query

data = {
    'grant_type': 'refresh_token',
    'client_id': os.environ.get('SID_CLIENT_ID'),
    'client_secret': os.environ.get('SID_CLIENT_SECRET'),
    'redirect_uri': os.environ.get('SID_REDIRECT_URI'),
    'refresh_token': refresh_token,
}

async with httpx.AsyncClient() as client:
    response = await client.post('https://auth.sid.ai/oauth/token', data=data)

access_token = response.json()['access_token']
```
</CodeGroup>

## Storing Tokens
The tokens are values which are associated with a particular user of your application.
Hence, you should store them in your database, associated with the user's account. 
For exmple, your `users` table could have the following additional columns: 

- `sid_access_token`
- `sid_refresh_token`
- `sid_expires_at`

When you receive the tokens, you should store them in these columns.
Then, when you need to make a request to the SID API, you can retrieve the access token from the database.

The expires_at value can be used to determine whether the access token is still valid, or whether you need to refresh it.

### Redis
As the refresh token is the only long-lived object, and new access tokens can always be derived from it,
it is not strictly necessary to store the access token in your database.
You may want to consider storing it in an in-memory cache such as Redis if performance is a concern.

In Redis, you can store the access token as an item with an expiry time. 
You can then retrieve it from Redis when you need to make a request to the SID API,
and refresh it if it is unavailable due to having expired.

<CardGroup cols={1}>
  <Card
    title="Access the API"
    icon="rocket"
    href="/build/query"
  >
    Use the access token to make your first request to the SID API
  </Card>
  {/* <Card
    title="Token Types"
    icon="key"
    href="/auth/tokens"
  >
    Learn more about the different tokens and how to handle them correctly
  </Card> */}
</CardGroup>
